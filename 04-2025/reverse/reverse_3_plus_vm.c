#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#ifdef _WIN32
#include <windows.h>
int detect_debugger() { return IsDebuggerPresent(); }
#else
int detect_debugger() { return 0; }
#endif

unsigned char encrypted_program[] = {
    174, 170, 170, 171, 171, 200, 168, 170, 200, 174, 170, 171, 171, 171, 195, 168, 170, 195, 174, 170, 168, 171, 171, 222, 168, 170, 222, 174, 170, 169, 171, 171, 221, 168, 170, 221, 174, 170, 174, 171, 171, 203, 168, 170, 203, 174, 170, 175, 171, 171, 198, 168, 170, 198, 174, 170, 172, 171, 171, 198, 168, 170, 198, 174, 170, 173, 171, 171, 217, 168, 170, 217, 174, 170, 162, 171, 171, 245, 168, 170, 245, 174, 170, 163, 171, 171, 201, 168, 170, 201, 174, 170, 160, 171, 171, 222, 168, 170, 222, 174, 170, 161, 171, 171, 204, 168, 170, 204, 174, 170, 166, 171, 171, 209, 168, 170, 209, 174, 170, 167, 171, 171, 206, 168, 170, 206, 174, 170, 164, 171, 171, 153, 168, 170, 153, 174, 170, 165, 171, 171, 222, 168, 170, 222, 174, 170, 186, 171, 171, 153, 168, 170, 153, 174, 170, 187, 171, 171, 201, 168, 170, 201, 174, 170, 184, 171, 171, 222, 168, 170, 222, 174, 170, 185, 171, 171, 245, 168, 170, 245, 174, 170, 190, 171, 171, 222, 168, 170, 222, 174, 170, 191, 171, 171, 194, 168, 170, 194, 174, 170, 188, 171, 171, 153, 168, 170, 153, 174, 170, 189, 171, 171, 245, 168, 170, 245, 174, 170, 178, 171, 171, 206, 168, 170, 206, 174, 170, 179, 171, 171, 200, 168, 170, 200, 174, 170, 176, 171, 171, 205, 168, 170, 205, 174, 170, 177, 171, 171, 245, 168, 170, 245, 174, 170, 182, 171, 171, 158, 168, 170, 158, 174, 170, 183, 171, 171, 196, 168, 170, 196, 174, 170, 180, 171, 171, 206, 168, 170, 206, 174, 170, 181, 171, 171, 245, 168, 170, 245, 174, 170, 138, 171, 171, 199, 168, 170, 199, 174, 170, 139, 171, 171, 154, 168, 170, 154, 174, 170, 136, 171, 171, 206, 168, 170, 206, 174, 170, 137, 171, 171, 245, 168, 170, 245, 174, 170, 142, 171, 171, 222, 168, 170, 222, 174, 170, 143, 171, 171, 194, 168, 170, 194, 174, 170, 140, 171, 171, 153, 168, 170, 153, 174, 170, 141, 171, 171, 245, 168, 170, 245, 174, 170, 130, 171, 171, 220, 168, 170, 220, 174, 170, 131, 171, 171, 199, 168, 170, 199, 174, 170, 128, 171, 171, 245, 168, 170, 245, 174, 170, 129, 171, 171, 204, 168, 170, 204, 174, 170, 134, 171, 171, 198, 168, 170, 198, 174, 170, 135, 171, 171, 154, 168, 170, 154, 174, 170, 132, 171, 171, 221, 168, 170, 221, 174, 170, 133, 171, 171, 215, 168, 170, 215, 85
};

unsigned char program[512];
int reg[4];

void decrypt_program() {
    for (int i = 0; i < sizeof(encrypted_program); i++) {
        program[i] = encrypted_program[i] ^ 0xAA;
    }
}

int run_vm(const char *input) {
    int ip = 0;
    while (1) {
        unsigned char op = program[ip++];
        switch (op) {
            case 0x01: { // MOV_REG_VAL
                int r = program[ip++];
                int val = program[ip++];
                reg[r] = val;
                break;
            }
            case 0x02: { // CMP_REG_VAL
                int r = program[ip++];
                int val = program[ip++];
                if (reg[r] != val) return 0;
                break;
            }
            case 0x03: { // CMP_INP_VAL
                int idx = program[ip++];
                char val = program[ip++];
                if (input[idx] != val) return 0;
                break;
            }
            case 0x04: { // MOV_REG_INP
                int r = program[ip++];
                int idx = program[ip++];
                reg[r] = input[idx];
                break;
            }
            case 0x05: { // XOR_REG_VAL
                int r = program[ip++];
                int val = program[ip++];
                reg[r] ^= val;
                break;
            }
            case 0x06: { // ADD_REG_VAL
                int r = program[ip++];
                int val = program[ip++];
                reg[r] += val;
                break;
            }
            case 0xFF:
                return 1;
        }
    }
}

int main() {
    if (detect_debugger()) {
        puts("Debugger detected.");
        return 1;
    }

    decrypt_program();

    char buf[128];
    printf("Enter flag: ");
    fgets(buf, sizeof(buf), stdin);
    buf[strcspn(buf, "\n")] = 0;

    if (run_vm(buf)) {
        puts("Correct!");
    } else {
        puts("Wrong.");
    }
    return 0;
}
